document.addEventListener('DOMContentLoaded',(()=>{const d=document,e={authContainer:d.getElementById('auth-container'),appContainer:d.getElementById('app-container'),signInForm:d.getElementById('sign-in-form'),signUpForm:d.getElementById('sign-up-form'),signinForm:d.getElementById('signin-form'),signupForm:d.getElementById('signup-form'),switchToSignup:d.getElementById('switch-to-signup'),switchToSignin:d.getElementById('switch-to-signin'),usernameDisplay:d.getElementById('username-display'),premiumBadge:d.getElementById('premium-badge'),logoutBtn:d.getElementById('logout-btn'),settingsLink:d.getElementById('settings-link'),historyLink:d.getElementById('history-link'),premiumLink:d.getElementById('premium-link'),backToAppBtn:d.getElementById('back-to-app-btn'),backToAppFromPremiumBtn:d.getElementById('back-to-app-from-premium-btn'),generatorSection:d.getElementById('generator-section'),editorSection:d.getElementById('editor-section'),historySection:d.getElementById('history-section'),settingsSection:d.getElementById('settings-section'),premiumSection:d.getElementById('premium-section'),promptForm:d.getElementById('prompt-form'),promptInput:d.getElementById('prompt-input'),imageStyle:d.getElementById('image-style'),imageSize:d.getElementById('image-size'),generateBtn:d.getElementById('generate-btn'),loading:d.getElementById('loading'),resultContainer:d.getElementById('result-container'),generatedImage:d.getElementById('generated-image'),editBtn:d.getElementById('edit-btn'),downloadBtn:d.getElementById('download-btn'),newImageBtn:d.getElementById('new-image-btn'),errorMessage:d.getElementById('error-message'),editorCanvas:d.getElementById('editor-canvas'),editorCtx:d.getElementById('editor-canvas').getContext('2d'),brightnessSlider:d.getElementById('brightness'),contrastSlider:d.getElementById('contrast'),saturationSlider:d.getElementById('saturation'),blurSlider:d.getElementById('blur'),resetEditBtn:d.getElementById('reset-edit-btn'),saveEditBtn:d.getElementById('save-edit-btn'),cancelEditBtn:d.getElementById('cancel-edit-btn'),historyGrid:d.getElementById('history-grid'),clearHistoryBtn:d.getElementById('clear-history-btn'),emptyHistory:d.getElementById('empty-history'),tabBtns:d.querySelectorAll('.tab-btn'),tabContents:d.querySelectorAll('.tab-content'),profileForm:d.getElementById('profile-form'),accountForm:d.getElementById('account-form'),preferencesForm:d.getElementById('preferences-form'),planBtns:d.querySelectorAll('.plan-btn:not(.current)'),downloadAppBtn:d.getElementById('download-app-btn'),themeToggle:d.getElementById('theme-toggle'),languageSelect:d.getElementById('language-select'),shareBtn:d.getElementById('share-btn'),exportFormat:d.getElementById('export-format'),exportQuality:d.getElementById('export-quality'),cropBtn:d.getElementById('crop-btn'),rotateBtn:d.getElementById('rotate-btn'),flipBtn:d.getElementById('flip-btn'),collectionsGrid:d.getElementById('collections-grid'),newCollectionBtn:d.getElementById('new-collection-btn'),addToCollectionBtn:d.getElementById('add-to-collection-btn')};let u=null,l=null,c=null,i=[];function g(){u=JSON.parse(localStorage.getItem('makeit_current_user')),u?m():v()}function v(){e.authContainer.classList.remove('hidden'),e.appContainer.classList.add('hidden')}function m(){e.authContainer.classList.add('hidden'),e.appContainer.classList.remove('hidden'),e.usernameDisplay.textContent=u.username,e.premiumBadge.classList.toggle('hidden',!u.isPremium),u.preferences&&(e.imageSize.value=u.preferences.imageSize||'512x512',e.imageStyle.value=u.preferences.imageStyle||'realistic',e.themeToggle.checked=u.preferences.theme==='light',e.languageSelect.value=u.preferences.language||'en',e.exportFormat.value=u.preferences.exportFormat||'png',e.exportQuality.value=u.preferences.exportQuality||'high',w(u.preferences.theme),k(u.preferences.language)),y('generator')}function y(t){[e.generatorSection,e.editorSection,e.historySection,e.settingsSection,e.premiumSection].forEach(t=>t.classList.add('hidden'));const n={generator:e.generatorSection,editor:e.editorSection,history:e.historySection,settings:e.settingsSection,premium:e.premiumSection};n[t]?.classList.remove('hidden')}function b(){d.getElementById('profile-username').value=u.username,d.getElementById('profile-email').value=u.email,d.getElementById('profile-bio').value=u.bio||'',u.preferences&&(d.getElementById('default-image-size').value=u.preferences.imageSize||'512x512',d.getElementById('default-image-style').value=u.preferences.imageStyle||'realistic',d.getElementById('save-history').value=u.preferences.saveHistory?'true':'false',d.getElementById('theme-select').value=u.preferences.theme||'dark',d.getElementById('language-select').value=u.preferences.language||'en',d.getElementById('export-format-select').value=u.preferences.exportFormat||'png',d.getElementById('export-quality-select').value=u.preferences.exportQuality||'high')}function h(){e.historyGrid.innerHTML='',u.history?.length>0?(e.emptyHistory.classList.add('hidden'),u.history.forEach((t,n)=>{const s=d.createElement('div');s.className='history-item',s.innerHTML=`<img src="${t.imageUrl}" alt="Generated image"><div class="history-item-prompt">${t.prompt}</div><div class="history-item-actions"><button class="download-history-btn" data-index="${n}"><i class="fas fa-download"></i></button><button class="delete-history-btn" data-index="${n}"><i class="fas fa-trash"></i></button></div>`,e.historyGrid.appendChild(s)}),d.querySelectorAll('.download-history-btn').forEach(t=>{t.addEventListener('click',(()=>{const n=u.history[t.dataset.index],s=d.createElement('a');s.href=n.imageUrl,s.download=`makeit-${n.id}.png`,d.body.appendChild(s),s.click(),d.body.removeChild(s)}))}),d.querySelectorAll('.delete-history-btn').forEach(t=>{t.addEventListener('click',(()=>{if(confirm('Are you sure you want to delete this image?')){u.history.splice(t.dataset.index,1);const t=JSON.parse(localStorage.getItem('makeit_users'))||[],n=t.findIndex(t=>t.username===u.username);-1!==n&&(t[n]=u,localStorage.setItem('makeit_users',JSON.stringify(t))),localStorage.setItem('makeit_current_user',JSON.stringify(u)),h(),_('Image deleted')}}))})):e.emptyHistory.classList.remove('hidden')}function C(){i=JSON.parse(localStorage.getItem('makeit_collections'))||[],e.collectionsGrid.innerHTML='',i.length>0&&i.forEach(t=>{const n=d.createElement('div');n.className='collection-item',n.innerHTML=`<h3>${t.name}</h3><p>${t.images.length} images</p><button class="view-collection-btn" data-id="${t.id}">View</button>`,e.collectionsGrid.appendChild(n)}),d.querySelectorAll('.view-collection-btn').forEach(t=>{t.addEventListener('click',(()=>{const n=parseInt(t.dataset.id),s=i.find(t=>t.id===n);s&&x(s)}))})}function x(t){alert(`Collection: ${t.name}\nImages: ${t.images.length}`)}async function S(t){try{const n=e.imageSize.value,s=e.imageStyle.value,o=Math.floor(1e6*Math.random()),r=n.split('x'),a=`${t}, ${s} style`,c=encodeURIComponent(a),l=`https://image.pollinations.ai/prompt/${c}?width=${r[0]}&height=${r[1]}&seed=${o}&nologo=true`,h=await fetch(l);if(!h.ok)throw new Error(`Failed to generate image: ${h.status}`);c=await h.blob();const g=URL.createObjectURL(c);A(g),u.preferences?.saveHistory&&E(t,g)}catch(t){j(`Failed to generate image: ${t.message}`),console.error('Generation error:',t),P()}}function E(t,n){const s=JSON.parse(localStorage.getItem('makeit_users'))||[],o={id:Date.now(),prompt:t,imageUrl:n,timestamp:(new Date).toISOString()};u.history||(u.history=[]),u.history.unshift(o),u.history.length>50&&(u.history=u.history.slice(0,50));const r=s.findIndex(t=>t.username===u.username);-1!==r&&(s[r]=u,localStorage.setItem('makeit_users',JSON.stringify(s))),localStorage.setItem('makeit_current_user',JSON.stringify(u))}function A(t){e.generatedImage.src=t,e.resultContainer.classList.remove('hidden'),P()}function O(){const t=e.brightnessSlider.value,n=e.contrastSlider.value,s=e.saturationSlider.value,o=e.blurSlider.value;e.editorCtx.filter=`brightness(${t}%) contrast(${n}%) saturate(${s}%) blur(${o}px)`;const r=new Image;r.onload=()=>{e.editorCtx.clearRect(0,0,e.editorCanvas.width,e.editorCanvas.height),e.editorCtx.drawImage(r,0,0)},r.src=e.generatedImage.src}function T(t){const n={grayscale:'grayscale(100%)',sepia:'sepia(100%)',invert:'invert(100%)',vintage:'sepia(50%) contrast(120%) brightness(90%)'};e.editorCtx.filter=n[t];const s=new Image;s.onload=()=>{e.editorCtx.clearRect(0,0,e.editorCanvas.width,e.editorCanvas.height),e.editorCtx.drawImage(s,0,0)},s.src=e.generatedImage.src}function L(){e.loading.classList.remove('hidden'),e.generateBtn.disabled=!0,e.generateBtn.textContent='Generating...'}function P(){e.loading.classList.add('hidden'),e.generateBtn.disabled=!1,e.generateBtn.textContent='Generate'}function j(t){e.errorMessage.textContent=t,e.errorMessage.classList.remove('hidden'),setTimeout((()=>{e.errorMessage.classList.add('hidden')}),5e3)}function _(t){e.errorMessage.textContent=t,e.errorMessage.style.backgroundColor='rgba(16, 185, 129, 0.2)',e.errorMessage.style.borderLeftColor='#10b981',e.errorMessage.classList.remove('hidden'),setTimeout((()=>{e.errorMessage.classList.add('hidden'),e.errorMessage.style.backgroundColor='',e.errorMessage.style.borderLeftColor=''}),3e3)}function I(t){e.errorMessage.textContent=t,e.errorMessage.style.backgroundColor='rgba(59, 130, 246, 0.2)',e.errorMessage.style.borderLeftColor='#3b82f6',e.errorMessage.classList.remove('hidden'),setTimeout((()=>{e.errorMessage.classList.add('hidden'),e.errorMessage.style.backgroundColor='',e.errorMessage.style.borderLeftColor=''}),3e3)}function q(){e.resultContainer.classList.add('hidden'),e.errorMessage.classList.add('hidden'),e.generatedImage.src='',c=null}function D(){window.addEventListener('beforeinstallprompt',(t=>{t.preventDefault(),l=t})),window.addEventListener('appinstalled',(()=>_('App installed successfully!')))}function w(t){'light'===t?document.body.classList.add('light-theme'):document.body.classList.remove('light-theme')}function M(){const t=localStorage.getItem('makeit_theme')||'dark';w(t),e.themeToggle.checked='light'===t}function k(t){console.log(`Language set to: ${t}`)}function U(){const t=localStorage.getItem('makeit_language')||'en';e.languageSelect.value=t,k(t)}g(),C(),D(),M(),U(),e.switchToSignup.addEventListener('click',(t=>{t.preventDefault(),e.signInForm.classList.add('hidden'),e.signUpForm.classList.remove('hidden')})),e.switchToSignin.addEventListener('click',(t=>{t.preventDefault(),e.signUpForm.classList.add('hidden'),e.signInForm.classList.remove('hidden')})),e.signinForm.addEventListener('submit',(t=>{t.preventDefault();const n=d.getElementById('signin-username').value,s=d.getElementById('signin-password').value,o=JSON.parse(localStorage.getItem('makeit_users'))||[],r=o.find((t=>(t.username===n||t.email===n)&&t.password===s));r?(localStorage.setItem('makeit_current_user',JSON.stringify(r)),m()):j('Invalid username/email or password')})),e.signupForm.addEventListener('submit',(t=>{t.preventDefault();const n=d.getElementById('signup-username').value,s=d.getElementById('signup-email').value,o=d.getElementById('signup-password').value,r=JSON.parse(localStorage.getItem('makeit_users'))||[];if(r.some((t=>t.username===n)))return j('Username already exists');if(r.some((t=>t.email===s)))return j('Email already exists');const a={username:n,email:s,password:o,bio:'',isPremium:!1,preferences:{imageSize:'512x512',imageStyle:'realistic',saveHistory:!0,theme:'dark',language:'en',exportFormat:'png',exportQuality:'high'},history:[],collections:[]};r.push(a),localStorage.setItem('makeit_users',JSON.stringify(r)),localStorage.setItem('makeit_current_user',JSON.stringify(a)),m()})),e.logoutBtn.addEventListener('click',(t=>{t.preventDefault(),localStorage.removeItem('makeit_current_user'),v()})),e.settingsLink.addEventListener('click',(t=>{t.preventDefault(),y('settings'),b()})),e.historyLink.addEventListener('click',(t=>{t.preventDefault(),y('history'),h()})),e.premiumLink.addEventListener('click',(t=>{t.preventDefault(),y('premium')})),e.backToAppBtn.addEventListener('click',(()=>y('generator'))),e.backToAppFromPremiumBtn.addEventListener('click',(()=>y('generator'))),e.tabBtns.forEach((t=>{t.addEventListener('click',(()=>{e.tabBtns.forEach((t=>t.classList.remove('active'))),e.tabContents.forEach((t=>t.classList.add('hidden'))),t.classList.add('active'),d.getElementById(`${t.dataset.tab}-tab`).classList.remove('hidden')}))})),e.profileForm.addEventListener('submit',(t=>{t.preventDefault();const n=JSON.parse(localStorage.getItem('makeit_users'))||[],s={...u,username:d.getElementById('profile-username').value,email:d.getElementById('profile-email').value,bio:d.getElementById('profile-bio').value},o=n.findIndex((t=>t.username===u.username));-1!==o&&(n[o]=s,localStorage.setItem('makeit_users',JSON.stringify(n))),localStorage.setItem('makeit_current_user',JSON.stringify(s)),e.usernameDisplay.textContent=s.username,_('Profile updated successfully')})),e.accountForm.addEventListener('submit',(t=>{t.preventDefault();const n=d.getElementById('current-password').value,s=d.getElementById('new-password').value,o=d.getElementById('confirm-password').value,r=JSON.parse(localStorage.getItem('makeit_users'))||[];if(u.password!==n)return j('Current password is incorrect');if(s!==o)return j('New passwords do not match');const a={...u,password:s},c=r.findIndex((t=>t.username===u.username));-1!==c&&(r[c]=a,localStorage.setItem('makeit_users',JSON.stringify(r))),localStorage.setItem('makeit_current_user',JSON.stringify(a)),e.accountForm.reset(),_('Password updated successfully')})),e.preferencesForm.addEventListener('submit',(t=>{t.preventDefault();const n=JSON.parse(localStorage.getItem('makeit_users'))||[],s={...u,preferences:{...u.preferences,imageSize:d.getElementById('default-image-size').value,imageStyle:d.getElementById('default-image-style').value,saveHistory:'true'===d.getElementById('save-history').value,theme:d.getElementById('theme-select').value,language:d.getElementById('language-select').value,exportFormat:d.getElementById('export-format-select').value,exportQuality:d.getElementById('export-quality-select').value}},o=n.findIndex((t=>t.username===u.username));-1!==o&&(n[o]=s,localStorage.setItem('makeit_users',JSON.stringify(n))),localStorage.setItem('makeit_current_user',JSON.stringify(s)),w(s.preferences.theme),_('Preferences saved successfully')})),e.planBtns.forEach((t=>{t.addEventListener('click',(()=>{const n=t.closest('.plan').querySelector('h3').textContent.toLowerCase();'premium'===n?_('Premium feature coming soon!'):'pro'===n&&_('Pro feature coming soon!')}))})),e.downloadAppBtn.addEventListener('click',(()=>{l?(l.prompt(),l.userChoice.then((t=>{'accepted'===t.outcome&&_('App installed successfully!'),l=null}))):I('To install this app, look for the install option in your browser menu')})),e.themeToggle.addEventListener('change',(()=>{const t=e.themeToggle.checked?'light':'dark';if(w(t),u){const n=JSON.parse(localStorage.getItem('makeit_users'))||[],s={...u,preferences:{...u.preferences,theme:t}},o=n.findIndex((t=>t.username===u.username));-1!==o&&(n[o]=s,localStorage.setItem('makeit_users',JSON.stringify(n))),localStorage.setItem('makeit_current_user',JSON.stringify(s))}})),e.languageSelect.addEventListener('change',(()=>{const t=e.languageSelect.value;if(k(t),u){const n=JSON.parse(localStorage.getItem('makeit_users'))||[],s={...u,preferences:{...u.preferences,language:t}},o=n.findIndex((t=>t.username===u.username));-1!==o&&(n[o]=s,localStorage.setItem('makeit_users',JSON.stringify(n))),localStorage.setItem('makeit_current_user',JSON.stringify(s))}})),e.promptForm.addEventListener('submit',(t=>{t.preventDefault();const n=e.promptInput.value.trim();n?(q(),L(),S(n)):j("Please enter a description for your image")})),e.editBtn.addEventListener('click',(()=>{if(!c)return;const t=new Image;t.onload=()=>{e.editorCanvas.width=t.width,e.editorCanvas.height=t.height,e.editorCtx.drawImage(t,0,0),e.brightnessSlider.value=100,e.contrastSlider.value=100,e.saturationSlider.value=100,e.blurSlider.value=0,y('editor')},t.src=URL.createObjectURL(c)})),[e.brightnessSlider,e.contrastSlider,e.saturationSlider,e.blurSlider].forEach((t=>{t.addEventListener('input',O)})),d.querySelectorAll('.filter-btn').forEach((t=>{t.addEventListener('click',(()=>T(t.dataset.filter)))})),e.resetEditBtn.addEventListener('click',(()=>{e.brightnessSlider.value=100,e.contrastSlider.value=100,e.saturationSlider.value=100,e.blurSlider.value=0,e.editorCtx.filter='none';const t=new Image;t.onload=()=>{e.editorCtx.clearRect(0,0,e.editorCanvas.width,e.editorCanvas.height),e.editorCtx.drawImage(t,0,0)},t.src=e.generatedImage.src})),e.saveEditBtn.addEventListener('click',(()=>{const t=u?.preferences?.exportFormat||'png',n=u?.preferences?.exportQuality==='high'?.9:.7;e.editorCanvas.toBlob((s=>{const o=URL.createObjectURL(s),r=d.createElement('a');r.href=o,r.download=`makeit-edited-${Date.now()}.${t}`,d.body.appendChild(r),r.click(),d.body.removeChild(r),y('generator')}),`image/${t}`,n)})),e.cancelEditBtn.addEventListener('click',(()=>y('generator'))),e.cropBtn.addEventListener('click',(()=>I('Crop feature coming soon!'))),e.rotateBtn.addEventListener('click',(()=>{const t=new Image;t.onload=()=>{e.editorCanvas.width=t.height,e.editorCanvas.height=t.width,e.editorCtx.save(),e.editorCtx.translate(e.editorCanvas.width/2,e.editorCanvas.height/2),e.editorCtx.rotate(Math.PI/2),e.editorCtx.drawImage(t,-t.width/2,-t.height/2),e.editorCtx.restore()},t.src=e.generatedImage.src})),e.flipBtn.addEventListener('click',(()=>{const t=new Image;t.onload=()=>{e.editorCtx.save(),e.editorCtx.scale(-1,1),e.editorCtx.drawImage(t,-t.width,0),e.editorCtx.restore()},t.src=e.generatedImage.src})),e.shareBtn.addEventListener('click',(()=>{navigator.share?navigator.share({title:'Check out this AI-generated image!',text:'Created with MakeIt AI',url:window.location.href}).then((()=>_('Shared successfully!'))).catch((t=>{console.error('Error sharing:',t)})):I('Sharing not supported on this device')})),e.clearHistoryBtn.addEventListener('click',(()=>{if(confirm('Are you sure you want to clear all history?')){const t=JSON.parse(localStorage.getItem('makeit_users'))||[],n={...u,history:[]},s=t.findIndex((t=>t.username===u.username));-1!==s&&(t[s]=n,localStorage.setItem('makeit_users',JSON.stringify(t))),localStorage.setItem('makeit_current_user',JSON.stringify(n)),h(),_('History cleared')}}})),e.downloadBtn.addEventListener('click',(()=>{if(!c)return;const t=u?.preferences?.exportFormat||'png',n=u?.preferences?.exportQuality==='high'?.9:.7,s=d.createElement('a');s.href=URL.createObjectURL(c),s.download=`makeit-${Date.now()}.${t}`,d.body.appendChild(s),s.click(),d.body.removeChild(s)})),e.newImageBtn.addEventListener('click',(()=>{q(),e.promptInput.focus()})),e.newCollectionBtn.addEventListener('click',(()=>{const t=prompt('Enter collection name:');if(t){const n={id:Date.now(),name:t,images:[]};i.push(n),localStorage.setItem('makeit_collections',JSON.stringify(i)),C(),_('Collection created successfully')}})),e.addToCollectionBtn.addEventListener('click',(()=>{if(!c)return;if(0===i.length)return I('Create a collection first');const t=i.map((t=>t.name)),n=prompt(`Select collection:\n${t.join('\n')}`);if(n){const t=i.find((t=>t.name===n));if(t){const s={id:Date.now(),prompt:e.promptInput.value,blobUrl:URL.createObjectURL(c),timestamp:(new Date).toISOString()};t.images.push(s),localStorage.setItem('makeit_collections',JSON.stringify(i)),_(`Added to ${n} collection`)}}}))}));