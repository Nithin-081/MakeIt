document.addEventListener('DOMContentLoaded',()=>{const d=document,e={authContainer:d.getElementById('auth-container'),appContainer:d.getElementById('app-container'),signInForm:d.getElementById('sign-in-form'),signUpForm:d.getElementById('sign-up-form'),signinForm:d.getElementById('signin-form'),signupForm:d.getElementById('signup-form'),switchToSignup:d.getElementById('switch-to-signup'),switchToSignin:d.getElementById('switch-to-signin'),usernameDisplay:d.getElementById('username-display'),premiumBadge:d.getElementById('premium-badge'),logoutBtn:d.getElementById('logout-btn'),settingsLink:d.getElementById('settings-link'),historyLink:d.getElementById('history-link'),premiumLink:d.getElementById('premium-link'),backToAppBtn:d.getElementById('back-to-app-btn'),backToAppFromPremiumBtn:d.getElementById('back-to-app-from-premium-btn'),generatorSection:d.getElementById('generator-section'),editorSection:d.getElementById('editor-section'),historySection:d.getElementById('history-section'),settingsSection:d.getElementById('settings-section'),premiumSection:d.getElementById('premium-section'),promptForm:d.getElementById('prompt-form'),promptInput:d.getElementById('prompt-input'),imageStyle:d.getElementById('image-style'),imageSize:d.getElementById('image-size'),generateBtn:d.getElementById('generate-btn'),loading:d.getElementById('loading'),resultContainer:d.getElementById('result-container'),generatedImage:d.getElementById('generated-image'),editBtn:d.getElementById('edit-btn'),downloadBtn:d.getElementById('download-btn'),newImageBtn:d.getElementById('new-image-btn'),errorMessage:d.getElementById('error-message'),editorCanvas:d.getElementById('editor-canvas'),editorCtx:d.getElementById('editor-canvas').getContext('2d'),brightnessSlider:d.getElementById('brightness'),contrastSlider:d.getElementById('contrast'),saturationSlider:d.getElementById('saturation'),blurSlider:d.getElementById('blur'),resetEditBtn:d.getElementById('reset-edit-btn'),saveEditBtn:d.getElementById('save-edit-btn'),cancelEditBtn:d.getElementById('cancel-edit-btn'),historyGrid:d.getElementById('history-grid'),clearHistoryBtn:d.getElementById('clear-history-btn'),emptyHistory:d.getElementById('empty-history'),tabBtns:d.querySelectorAll('.tab-btn'),tabContents:d.querySelectorAll('.tab-content'),profileForm:d.getElementById('profile-form'),accountForm:d.getElementById('account-form'),preferencesForm:d.getElementById('preferences-form'),planBtns:d.querySelectorAll('.plan-btn:not(.current)')};let u=null;checkAuthStatus();e.switchToSignup.addEventListener('click',t=>{t.preventDefault();e.signInForm.classList.add('hidden');e.signUpForm.classList.remove('hidden')});e.switchToSignin.addEventListener('click',t=>{t.preventDefault();e.signUpForm.classList.add('hidden');e.signInForm.classList.remove('hidden')});e.signinForm.addEventListener('submit',t=>{t.preventDefault();const n=d.getElementById('signin-username').value,s=d.getElementById('signin-password').value,i=JSON.parse(localStorage.getItem('makeit_users'))||[],o=i.find(t=>(t.username===n||t.email===n)&&t.password===s);o?(localStorage.setItem('makeit_current_user',JSON.stringify(o)),showApp()):alert('Invalid username/email or password')});e.signupForm.addEventListener('submit',t=>{t.preventDefault();const n=d.getElementById('signup-username').value,s=d.getElementById('signup-email').value,i=d.getElementById('signup-password').value,o=JSON.parse(localStorage.getItem('makeit_users'))||[];if(o.some(t=>t.username===n))return alert('Username already exists');if(o.some(t=>t.email===s))return alert('Email already exists');const r={username:n,email:s,password:i,bio:'',isPremium:!1,preferences:{imageSize:'512x512',imageStyle:'realistic',saveHistory:!0},history:[]};o.push(r),localStorage.setItem('makeit_users',JSON.stringify(o)),localStorage.setItem('makeit_current_user',JSON.stringify(r)),showApp()});e.logoutBtn.addEventListener('click',t=>{t.preventDefault();localStorage.removeItem('makeit_current_user');showAuth()});e.settingsLink.addEventListener('click',t=>{t.preventDefault();showSection('settings');loadSettings()});e.historyLink.addEventListener('click',t=>{t.preventDefault();showSection('history');loadHistory()});e.premiumLink.addEventListener('click',t=>{t.preventDefault();showSection('premium')});e.backToAppBtn.addEventListener('click',()=>showSection('generator'));e.backToAppFromPremiumBtn.addEventListener('click',()=>showSection('generator'));e.tabBtns.forEach(t=>{t.addEventListener('click',()=>{e.tabBtns.forEach(t=>t.classList.remove('active'));e.tabContents.forEach(t=>t.classList.add('hidden'));t.classList.add('active');d.getElementById(`${t.dataset.tab}-tab`).classList.remove('hidden')})});e.profileForm.addEventListener('submit',t=>{t.preventDefault();const n=JSON.parse(localStorage.getItem('makeit_users'))||[],s={...u,username:d.getElementById('profile-username').value,email:d.getElementById('profile-email').value,bio:d.getElementById('profile-bio').value},i=n.findIndex(t=>t.username===u.username);-1!==i&&(n[i]=s,localStorage.setItem('makeit_users',JSON.stringify(n)));localStorage.setItem('makeit_current_user',JSON.stringify(s));e.usernameDisplay.textContent=s.username;alert('Profile updated successfully')});e.accountForm.addEventListener('submit',t=>{t.preventDefault();const n=d.getElementById('current-password').value,s=d.getElementById('new-password').value,i=d.getElementById('confirm-password').value,o=JSON.parse(localStorage.getItem('makeit_users'))||[];if(u.password!==n)return alert('Current password is incorrect');if(s!==i)return alert('New passwords do not match');const r={...u,password:s},a=o.findIndex(t=>t.username===u.username);-1!==a&&(o[a]=r,localStorage.setItem('makeit_users',JSON.stringify(o)));localStorage.setItem('makeit_current_user',JSON.stringify(r));e.accountForm.reset();alert('Password updated successfully')});e.preferencesForm.addEventListener('submit',t=>{t.preventDefault();const n=JSON.parse(localStorage.getItem('makeit_users'))||[],s={...u,preferences:{imageSize:d.getElementById('default-image-size').value,imageStyle:d.getElementById('default-image-style').value,saveHistory:'true'===d.getElementById('save-history').value}},i=n.findIndex(t=>t.username===u.username);-1!==i&&(n[i]=s,localStorage.setItem('makeit_users',JSON.stringify(n)));localStorage.setItem('makeit_current_user',JSON.stringify(s));alert('Preferences saved successfully')});e.planBtns.forEach(t=>t.addEventListener('click',()=>alert('Premium feature coming soon!')));e.promptForm.addEventListener('submit',t=>{t.preventDefault();const n=e.promptInput.value.trim();n?(resetUI(),showLoading(),generateImage(n)):showError("Please enter a description for your image")});e.editBtn.addEventListener('click',()=>{const t=new Image;t.onload=()=>{e.editorCanvas.width=t.width;e.editorCanvas.height=t.height;e.editorCtx.drawImage(t,0,0);e.brightnessSlider.value=100;e.contrastSlider.value=100;e.saturationSlider.value=100;e.blurSlider.value=0;showSection('editor')};t.src=e.generatedImage.src});[e.brightnessSlider,e.contrastSlider,e.saturationSlider,e.blurSlider].forEach(t=>{t.addEventListener('input',applyFilters)});d.querySelectorAll('.filter-btn').forEach(t=>{t.addEventListener('click',()=>applyPresetFilter(t.dataset.filter))});e.resetEditBtn.addEventListener('click',()=>{e.brightnessSlider.value=100;e.contrastSlider.value=100;e.saturationSlider.value=100;e.blurSlider.value=0;e.editorCtx.filter='none';const t=new Image;t.onload=()=>{e.editorCtx.clearRect(0,0,e.editorCanvas.width,e.editorCanvas.height);e.editorCtx.drawImage(t,0,0)};t.src=e.generatedImage.src});e.saveEditBtn.addEventListener('click',()=>{e.editorCanvas.toBlob(t=>{const n=URL.createObjectURL(t),s=d.createElement('a');s.href=n;s.download=`makeit-edited-${Date.now()}.png`;d.body.appendChild(s);s.click();d.body.removeChild(s);showSection('generator')})});e.cancelEditBtn.addEventListener('click',()=>showSection('generator'));e.clearHistoryBtn.addEventListener('click',()=>{if(confirm('Are you sure you want to clear all history?')){const t=JSON.parse(localStorage.getItem('makeit_users'))||[],n={...u,history:[]},s=t.findIndex(t=>t.username===u.username);-1!==s&&(t[s]=n,localStorage.setItem('makeit_users',JSON.stringify(t)));localStorage.setItem('makeit_current_user',JSON.stringify(n));loadHistory()}});e.downloadBtn.addEventListener('click',()=>{const t=d.createElement('a');t.href=e.generatedImage.src;t.download=`makeit-${Date.now()}.png`;d.body.appendChild(t);t.click();d.body.removeChild(t)});e.newImageBtn.addEventListener('click',()=>{resetUI();e.promptInput.focus()});function checkAuthStatus(){u=JSON.parse(localStorage.getItem('makeit_current_user'));u?showApp():showAuth()}function showAuth(){e.authContainer.classList.remove('hidden');e.appContainer.classList.add('hidden')}function showApp(){e.authContainer.classList.add('hidden');e.appContainer.classList.remove('hidden');e.usernameDisplay.textContent=u.username;e.premiumBadge.classList.toggle('hidden',!u.isPremium);u.preferences&&(e.imageSize.value=u.preferences.imageSize||'512x512',e.imageStyle.value=u.preferences.imageStyle||'realistic');showSection('generator')}function showSection(t){[e.generatorSection,e.editorSection,e.historySection,e.settingsSection,e.premiumSection].forEach(t=>t.classList.add('hidden'));const n={generator:e.generatorSection,editor:e.editorSection,history:e.historySection,settings:e.settingsSection,premium:e.premiumSection};n[t]?.classList.remove('hidden')}function loadSettings(){d.getElementById('profile-username').value=u.username;d.getElementById('profile-email').value=u.email;d.getElementById('profile-bio').value=u.bio||'';u.preferences&&(d.getElementById('default-image-size').value=u.preferences.imageSize||'512x512',d.getElementById('default-image-style').value=u.preferences.imageStyle||'realistic',d.getElementById('save-history').value=u.preferences.saveHistory?'true':'false')}function loadHistory(){e.historyGrid.innerHTML='';u.history?.length>0?(e.emptyHistory.classList.add('hidden'),u.history.forEach((t,n)=>{const s=d.createElement('div');s.className='history-item';s.innerHTML=`<img src="${t.imageUrl}" alt="Generated image"><div class="history-item-prompt">${t.prompt}</div><div class="history-item-actions"><button class="download-history-btn" data-index="${n}"><i class="fas fa-download"></i></button><button class="delete-history-btn" data-index="${n}"><i class="fas fa-trash"></i></button></div>`;e.historyGrid.appendChild(s)}),d.querySelectorAll('.download-history-btn').forEach(t=>{t.addEventListener('click',()=>{const n=u.history[t.dataset.index],s=d.createElement('a');s.href=n.imageUrl;s.download=`makeit-${n.id}.png`;d.body.appendChild(s);s.click();d.body.removeChild(s)})}),d.querySelectorAll('.delete-history-btn').forEach(t=>{t.addEventListener('click',()=>{if(confirm('Are you sure you want to delete this image?')){u.history.splice(t.dataset.index,1);const t=JSON.parse(localStorage.getItem('makeit_users'))||[],n=t.findIndex(t=>t.username===u.username);-1!==n&&(t[n]=u,localStorage.setItem('makeit_users',JSON.stringify(t)));localStorage.setItem('makeit_current_user',JSON.stringify(u));loadHistory()}})})):e.emptyHistory.classList.remove('hidden')}async function generateImage(t){try{const n=e.imageSize.value,s=e.imageStyle.value,i=Math.floor(1e6*Math.random()),o=n.split('x'),r=`${t}, ${s} style`,a=encodeURIComponent(r),c=`https://image.pollinations.ai/prompt/${a}?width=${o[0]}&height=${o[1]}&seed=${i}&nologo=true`,l=await fetch(c);if(!l.ok)throw new Error(`Failed to generate image: ${l.status}`);const h=await l.blob(),g=URL.createObjectURL(h);displayImage(g);u.preferences?.saveHistory&&saveToHistory(t,g)}catch(t){showError(`Failed to generate image: ${t.message}`);console.error("Generation error:",t);hideLoading()}}function saveToHistory(t,n){const s=JSON.parse(localStorage.getItem('makeit_users'))||[],i={id:Date.now(),prompt:t,imageUrl:n,timestamp:(new Date).toISOString()};u.history||(u.history=[]);u.history.unshift(i);u.history.length>50&&(u.history=u.history.slice(0,50));const o=s.findIndex(t=>t.username===u.username);-1!==o&&(s[o]=u);localStorage.setItem('makeit_users',JSON.stringify(s));localStorage.setItem('makeit_current_user',JSON.stringify(u))}function displayImage(t){e.generatedImage.src=t;e.resultContainer.classList.remove('hidden');hideLoading()}function applyFilters(){const t=e.brightnessSlider.value,n=e.contrastSlider.value,s=e.saturationSlider.value,i=e.blurSlider.value;e.editorCtx.filter=`brightness(${t}%) contrast(${n}%) saturate(${s}%) blur(${i}px)`;const o=new Image;o.onload=()=>{e.editorCtx.clearRect(0,0,e.editorCanvas.width,e.editorCanvas.height);e.editorCtx.drawImage(o,0,0)};o.src=e.generatedImage.src}function applyPresetFilter(t){const n={grayscale:'grayscale(100%)',sepia:'sepia(100%)',invert:'invert(100%)',vintage:'sepia(50%) contrast(120%) brightness(90%)'};e.editorCtx.filter=n[t];const s=new Image;s.onload=()=>{e.editorCtx.clearRect(0,0,e.editorCanvas.width,e.editorCanvas.height);e.editorCtx.drawImage(s,0,0)};s.src=e.generatedImage.src}function showLoading(){e.loading.classList.remove('hidden');e.generateBtn.disabled=!0;e.generateBtn.textContent="Generating..."}function hideLoading(){e.loading.classList.add('hidden');e.generateBtn.disabled=!1;e.generateBtn.textContent="Generate"}function showError(t){e.errorMessage.textContent=t;e.errorMessage.classList.remove('hidden')}function resetUI(){e.resultContainer.classList.add('hidden');e.errorMessage.classList.add('hidden');e.generatedImage.src=""}});